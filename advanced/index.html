<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Advanced - CODAL</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/base.css" rel="stylesheet">
        <link href="../css/extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-76156484-1', 'auto');
            ga('send', 'pageview');
        </script>
        
    </head>

    <body>

        <div class="navbar navbar-custom navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            
                <a class="navbar-brand" style="padding-top:25px; padding-bottom:25px" rel="home" href="..">CODAL</a>
            
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            

            
                <li >
                    <a href="..">Introduction</a>
                </li>
            
            

            
                <li >
                    <a href="../installation/">Installation Guide</a>
                </li>
            
            

            
                <li >
                    <a href="../devices/">Devices</a>
                </li>
            
            

            
                <li class="active">
                    <a href="./">Advanced</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right hidden-md hidden-sm">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                <li >
                    <a rel="next" href="../devices/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li class="disabled">
                    <a rel="prev" >
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/lancaster-university/codal/">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#advanced">Advanced</a></li>
        
            <li><a href="#architecture">Architecture</a></li>
        
            <li><a href="#libraries">Libraries</a></li>
        
            <li><a href="#targets">Targets</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="advanced">Advanced<a class="headerlink" href="#advanced" title="Permanent link">&para;</a></h1>
<h2 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link">&para;</a></h2>
<p>The CODAL runtime is formed of many libraries, the library common to <em>all</em> CODAL targets is known as <a href="https://github.com/lancaster-university/codal-core">codal-core</a>. This library contains common drivers, abstractions for common drivers (driver models), the scheduler and eventing mechanisms, central to the CODAL experience.</p>
<h2 id="libraries">Libraries<a class="headerlink" href="#libraries" title="Permanent link">&para;</a></h2>
<p>Libraries are simply collections of C/C++ files to be used in the final binary. CMakeLists.txt define the contents and dependencies of a library. Here's an example for codal-core:</p>
<pre><code class="cmake">include(&quot;${CODAL_UTILS_LOCATION}&quot;)

include(&quot;${CODAL_UTILS_LOCATION}&quot;)
RECURSIVE_FIND_DIR(INCLUDE_DIRS &quot;./inc&quot; &quot;*.h&quot;)
RECURSIVE_FIND_FILE(SOURCE_FILES &quot;./source&quot; &quot;*.c??&quot;)

execute_process(WORKING_DIRECTORY &quot;.&quot; COMMAND &quot;git&quot; &quot;log&quot; &quot;--pretty=format:%h&quot; &quot;-n&quot; &quot;1&quot; OUTPUT_VARIABLE git_hash)
execute_process(WORKING_DIRECTORY &quot;.&quot; COMMAND &quot;git&quot; &quot;rev-parse&quot; &quot;--abbrev-ref&quot; &quot;HEAD&quot; OUTPUT_VARIABLE git_branch OUTPUT_STRIP_TRAILING_WHITESPACE)

if (&quot;${git_branch}&quot; STREQUAL &quot;master&quot;)
    set(CODAL_VERSION_STRING &quot;${CODAL_VERSION_STRING}&quot;)
else()
    set(CODAL_VERSION_STRING &quot;${CODAL_VERSION_STRING}-${git_branch}-g${git_hash}&quot;)
endif()

set(CODAL_VERSION_FLAGS &quot;-DCODAL_VERSION=\\\&quot;${CODAL_VERSION_STRING}\\\&quot;&quot;)

set (CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} ${CODAL_VERSION_FLAGS}&quot;)

add_library(codal-core
    ${SOURCE_FILES}
)

target_include_directories(codal-core PUBLIC ${INCLUDE_DIRS})
</code></pre>

<p>There are additional defines and function to help developers write CMakeLists.txt.</p>
<p><code>${CODAL_UTILS_LOCATION}</code> defines the location where utility functions are kept, such as <code>RECURSIVE_FIND_DIR</code> and <code>RECURSIVE_FIND_FILE</code> useful for finding source and header files.</p>
<p>Before invoking any library <code>CMakeLists.txt</code>, codal's CMakeLists.txt defines information about the target and toolchain:
- <code>CODAL_TARGET_NAME</code> - The name of the current target.
- <code>CODAL_OUTPUT_NAME</code> - The name of the output binary.
- <code>CODAL_TARGET_PROCESSOR</code> - The name of the target processor.
- <code>CODAL_TARGET_CPU_ARCHITECTURE</code> - The architecture of the processor i.e. CortexM0.
- <code>TOOLCHAIN</code> - The toolchain e.g. AVR_GCC, ARM_GCC.</p>
<p>Libraries can be composed however you desire, however we recommend segmenting includes and source files into respective directories named "inc" and "source".</p>
<h2 id="targets">Targets<a class="headerlink" href="#targets" title="Permanent link">&para;</a></h2>
<p>Targets are libraries with one addition, a <code>target.json</code>.</p>
<p>The CODAL build system uses information in this file to select and configure toolchains, and download dependencies. <code>target.json</code> also contains information required to configure libraries, like mbed, as well as provide device specific definitions for codal-core. The <code>target.json</code> can also configure a post process task, executed from the root of CODAL.</p>
<p>Below is the <code>target.json</code> for the Circuit Playground:</p>
<pre><code class="json">{
    &quot;device&quot;:&quot;CIRCUIT_PLAYGROUND&quot;,
    &quot;processor&quot;:&quot;SAMD21G18A&quot;,
    &quot;architecture&quot;:&quot;CORTEX_M0_PLUS&quot;,
    &quot;toolchain&quot;:&quot;ARM_GCC&quot;,
    &quot;post_process&quot;:&quot;python ./utils/uf2conv.py -o &lt;OUTPUT_HEX_DESTINATION&gt;/&lt;OUTPUT_HEX_NAME&gt;.uf2 -c &lt;OUTPUT_BIN_LOCATION&gt;&quot;,
    &quot;generate_bin&quot;:true,
    &quot;generate_hex&quot;:true,
    &quot;config&quot;:{
        &quot;CODAL_TIMESTAMP&quot;:&quot;uint64_t&quot;,
        &quot;USB_MAX_PKT_SIZE&quot;: 64,
        &quot;DEVICE_USB_ENDPOINTS&quot;:8,
        &quot;USB_DEFAULT_PID&quot;:&quot;0x2402&quot;,
        &quot;USB_DEFAULT_VID&quot;:&quot;0x03EB&quot;,
        &quot;USB_EP_FLAG_NO_AUTO_ZLP&quot;:&quot;0x01&quot;,
        &quot;DEVICE_SRAM_BASE&quot;:&quot;0x20000000&quot;,
        &quot;DEVICE_SRAM_END&quot;:&quot;0x20008000&quot;,
        &quot;DEVICE_STACK_BASE&quot;:&quot;DEVICE_SRAM_END&quot;,
        &quot;DEVICE_STACK_SIZE&quot;:2048,
        &quot;TARGET_DEBUG_CLASS&quot;:&quot;NOT_IMPLEMENTED&quot;,
        &quot;DEVICE_HEAP_ALLOCATOR&quot;:1,
        &quot;DEVICE_TAG&quot;:0,
        &quot;SCHEDULER_TICK_PERIOD_US&quot;:6000,
        &quot;EVENT_LISTENER_DEFAULT_FLAGS&quot;:&quot;MESSAGE_BUS_LISTENER_QUEUE_IF_BUSY&quot;,
        &quot;MESSAGE_BUS_LISTENER_MAX_QUEUE_DEPTH&quot;:10,
        &quot;USE_ACCEL_LSB&quot;:0,
        &quot;DEVICE_DEFAULT_SERIAL_MODE&quot;:&quot;SYNC_SLEEP&quot;,
        &quot;DEVICE_COMPONENT_COUNT&quot;:30,
        &quot;DEVICE_DEFAULT_PULLMODE&quot;:&quot;PullMode::None&quot;,
        &quot;DEVICE_PANIC_HEAP_FULL&quot;:1,
        &quot;DEVICE_DMESG&quot;:1,
        &quot;DEVICE_DMESG_BUFFER_SIZE&quot;:1024,
        &quot;CODAL_DEBUG&quot;:0,
        &quot;DEVICE_USB&quot;:1,
        &quot;PROCESSOR_WORD_TYPE&quot;:&quot;uint32_t&quot;
    },
    &quot;definitions&quot;:&quot;-DCONF_CLOCKS_H_INCLUDED -DGCLK_PERIPHERAL_CLOCK=GCLK_GENERATOR_3 -DDEVICE_ANALOGIN -DDEVICE_ANALOGOUT -DDEVICE_I2C -DDEVICE_I2CSLAVE -DDEVICE_I2C_ASYNCH -DDEVICE_INTERRUPTIN -DDEVICE_PORTIN -DDEVICE_PORTINOUT -DDEVICE_PORTOUT -DDEVICE_RTC -DDEVICE_SERIAL -DDEVICE_SERIAL_ASYNCH -DDEVICE_SERIAL_FC -DDEVICE_SLEEP -DDEVICE_SPI -DDEVICE_PWMOUT -DDEVICE_SPISLAVE -DDEVICE_SPI_ASYNCH -DCONF_CLOCKS_H_INCLUDED -DGCLK_PERIPHERAL_CLOCK=GCLK_GENERATOR_3 -D__SAMD21G18A__ -D__CORTEX_M0PLUS -D__MBED__=1  -DTOOLCHAIN_GCC -DTOOLCHAIN_GCC_ARM -DMBED_OPERATORS -DTARGET_ADAFRUIT_CP_G18A -DI2C_MASTER_CALLBACK_MODE=true -DEXTINT_CALLBACK_MODE=true -DUSART_CALLBACK_MODE=true -DTC_ASYNC=true&quot;,
    &quot;cmake_definitions&quot;:{
        &quot;MBED_LEGACY_TARGET_DEFINITIONS&quot;:&quot;ADAFRUIT_CP_G18A;Atmel;SAM_CortexM0P;SAMD21&quot;,
        &quot;MBED_LEGACY_TOOLCHAIN&quot;:&quot;GCC_ARM;&quot;
    },
    &quot;cpu_opts&quot;:&quot;-mcpu=cortex-m0plus -mthumb&quot;,
    &quot;asm_flags&quot;:&quot;-fno-exceptions -fno-unwind-tables --specs=nosys.specs&quot;,
    &quot;c_flags&quot;:&quot;-std=c99 --specs=nosys.specs&quot;,
    &quot;cpp_flags&quot;:&quot;-std=c++11 -fwrapv -fno-rtti -fno-threadsafe-statics -fno-exceptions -fno-unwind-tables -Wl,--gc-sections -Wl,--sort-common -Wl,--sort-section=alignment&quot;,
    &quot;linker_flags&quot;:&quot;-Wl,--no-wchar-size-warning,-wrap,main&quot;,
    &quot;libraries&quot;:[
        {
            &quot;name&quot;:&quot;codal-core&quot;,
            &quot;url&quot;:&quot;https://github.com/lancaster-university/codal-core&quot;,
            &quot;branch&quot;:&quot;master&quot;,
            &quot;type&quot;:&quot;git&quot;
        },
        {
            &quot;name&quot;:&quot;mbed-classic&quot;,
            &quot;url&quot;:&quot;https://github.com/lancaster-university/mbed-classic&quot;,
            &quot;branch&quot;:&quot;new-build-system&quot;,
            &quot;type&quot;:&quot;git&quot;
        },
        {
            &quot;name&quot;:&quot;codal-samd21&quot;,
            &quot;url&quot;:&quot;https://github.com/lancaster-university/codal-samd21&quot;,
            &quot;branch&quot;:&quot;master&quot;,
            &quot;type&quot;:&quot;git&quot;
        },
        {
            &quot;name&quot;:&quot;codal-mbed&quot;,
            &quot;url&quot;:&quot;https://github.com/lancaster-university/codal-mbed&quot;,
            &quot;branch&quot;:&quot;master&quot;,
            &quot;type&quot;:&quot;git&quot;
        }
    ]
}
</code></pre></div>
        </div>

        <footer class="col-md-12">
            
            <center><a href="https://www.lancaster.ac.uk"><image style="width:auto;" height="61" src="../img/lancs-logo.png"></image></a></center>
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>